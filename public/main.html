<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>BlindTest V2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      min-width: 100vw;
      font-family: 'Inter', 'Segoe UI', sans-serif;
      background: linear-gradient(120deg, #e3e9ff 0%, #f7faff 50%, #f7eaff 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      overflow: hidden;
    }
    .main-container {
      width: 95vw;
      max-width: 1700px;
      height: 92vh;
      max-height: 950px;
      aspect-ratio: 16/9;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.92);
      border-radius: 40px;
      box-shadow: 0 12px 64px #0002;
      padding: 2vw 2vw 1vw 2vw;
      position: relative;
      overflow: hidden;
      gap: 1.2em;
    }
    #timer-dvd {
      position: absolute;
      left: 4vw;
      top: 4vh;
      z-index: 10;
      pointer-events: none;
      user-select: none;
      width: 8vw;
      min-width: 70px;
      max-width: 140px;
      text-align: center;
      font-size: 4vw;
      font-weight: 700;
      color: #5a6cff;
      text-shadow: 0 0 10px #5a6cff55;
      transition: color 0.3s, text-shadow 0.3s;
      will-change: transform, color;
      filter: drop-shadow(0 0 6px #5a6cff33);
      letter-spacing: 0.03em;
      background: rgba(255,255,255,0.18);
      border-radius: 1em;
      padding: 0.1em 0.2em;
      box-shadow: 0 2px 10px #5a6cff11;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.2em;
    }
    #buzzer {
      font-size: 2.2vw;
      margin: 0.5em 0 1.2em 0;
      font-weight: 600;
      transition: background 0.3s, color 0.3s, box-shadow 0.3s;
      padding: 0.7em 0.5em;
      border-radius: 1.2em;
      min-height: 2.7em;
      box-shadow: 0 2px 18px #5a6cff22;
      background: #f5f7ff;
      color: #5a6cff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 320px;
      max-width: 90vw;
    }
    .buzzer-pop {
      animation: buzzerPop 0.5s;
    }
    @keyframes buzzerPop {
      0% { transform: scale(1.15) rotate(-2deg); box-shadow: 0 0 32px #ff9800cc; }
      60% { transform: scale(1.05) rotate(2deg); box-shadow: 0 0 16px #ff9800aa; }
      100% { transform: scale(1) rotate(0deg); box-shadow: 0 2px 18px #5a6cff22; }
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 22px;
      margin: 24px 0 0 0;
    }
    .controls button {
      font-size: 1.4em;
      padding: 14px 36px 14px 48px;
      border-radius: 16px;
      border: none;
      background: linear-gradient(90deg, #5a6cff 60%, #7c4dff 100%);
      color: white;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      font-weight: 600;
      box-shadow: 0 2px 16px #5a6cff33;
      position: relative;
      outline: none;
      display: flex;
      align-items: center;
      gap: 0.7em;
    }
    .controls button:active {
      transform: scale(0.97);
    }
    .controls button:disabled {
      background: #bdbdbd;
      color: #fff;
      cursor: not-allowed;
      opacity: 0.7;
    }
    .controls button svg {
      width: 1.3em;
      height: 1.3em;
      margin-right: 0.3em;
      vertical-align: middle;
      fill: currentColor;
    }
    .controls button#reveal {
      background: linear-gradient(90deg, #ffb300 60%, #ff9800 100%);
      color: #fff;
    }
    .controls button#next {
      background: linear-gradient(90deg, #00bfae 60%, #00e676 100%);
      color: #fff;
    }
    #playlist-select {
      font-size: 1.2em;
      padding: 10px 24px;
      border-radius: 12px;
      border: 1.5px solid #5a6cff;
      margin-bottom: 18px;
      background: #fff;
      color: #5a6cff;
      font-weight: 600;
      box-shadow: 0 2px 12px #5a6cff11;
      outline: none;
      transition: border 0.2s;
    }
    #playlist-select:focus {
      border: 2px solid #7c4dff;
    }
    .playlist-info {
      font-size: 1.1em;
      color: #7c4dff;
      margin-bottom: 0.5em;
      font-weight: 600;
      text-align: center;
      letter-spacing: 0.02em;
    }
    #track {
      width: 480px;
      max-width: 95vw;
      min-height: 340px;
      margin: 0 auto 1em auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      box-sizing: border-box;
      gap: 0.7em;
    }
    #cover {
      width: 200px;
      height: 200px;
      object-fit: cover;
      border-radius: 24px;
      filter: blur(14px) brightness(0.7);
      margin-bottom: 18px;
      flex-shrink: 0;
      box-shadow: 0 4px 32px #7c4dff33;
      transition: filter 0.5s cubic-bezier(.4,2,.6,1), box-shadow 0.3s;
    }
    .revealed #cover {
      filter: none;
      box-shadow: 0 4px 32px #00e67655;
      animation: coverReveal 0.7s cubic-bezier(.4,2,.6,1);
    }
    @keyframes coverReveal {
      0% { filter: blur(14px) brightness(0.7); }
      100% { filter: none; }
    }
    .track-title, .track-artist {
      width: 100%;
      max-width: 1600px;
      overflow: visible;
      white-space: normal;
      word-break: break-word;
      text-align: center;
      margin: 0 auto 8px auto;
      display: block;
      cursor: pointer;
      font-family: inherit;
    }
    .track-title {
      font-size: 2.3em;
      font-weight: 800;
      color: #5a6cff;
      letter-spacing: 0.01em;
    }
    .track-artist {
      font-size: 1.5em;
      font-weight: 600;
      color: #7c4dff;
    }
    .hidden { display: none; }
    #track audio {
      width: 100%;
      max-width: 90vw;
      margin-top: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 12px #5a6cff22;
      background: #fff;
    }
    /* Responsive */
    @media (max-width: 900px) {
      .main-container { max-width: 99vw; height: 99vh; border-radius: 0; }
      #track { width: 98vw; }
      #cover { width: 38vw; height: 38vw; min-width: 120px; min-height: 120px; }
      #timer-dvd { font-size: 12vw; min-width: 80px; }
      #buzzer { font-size: 4vw; min-width: 120px; }
    }
    @media (max-width: 600px) {
      .main-container { padding: 0.5em; }
      #track { min-height: 180px; }
      #cover { width: 60vw; height: 60vw; }
      .controls button { font-size: 1em; padding: 10px 18px 10px 32px; border-radius: 10px; }
    }
    /* Loader */
    .loader {
      border: 4px solid #e3e9ff;
      border-top: 4px solid #5a6cff;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
      display: block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div id="timer-dvd">30</div>
    <div id="buzzer">Personne n'a buzzé</div>
    <div class="playlist-info" id="playlist-info"></div>
    <select id="playlist-select">
      <option value="">Choisir une playlist...</option>
    </select>
    <div id="track"></div>
    <div class="controls">
      <button id="playpause">
        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        <span>Play</span>
      </button>
      <button id="reveal" class="hidden">
        <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5z"/></svg>
        <span>Révéler</span>
      </button>
      <button id="next" class="hidden">
        <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zm9-12h2v12h-2z"/></svg>
        <span>Suivant</span>
      </button>
    </div>
  </div>
  <script type="module">
    import themes from './themes.js';
    let playlist = [];
    let currentIndex = 0;
    let revealed = false;
    let waitingForFirstPlay = false;
    const socket = io();
    const timerDVD = document.getElementById('timer-dvd');
    const buzzerDiv = document.getElementById('buzzer');
    const playlistSelect = document.getElementById('playlist-select');
    const playlistInfo = document.getElementById('playlist-info');
    const trackDiv = document.getElementById('track');
    const playPauseBtn = document.getElementById('playpause');
    const nextBtn = document.getElementById('next');
    const revealBtn = document.getElementById('reveal');

    // Prépare le son de buzz
    const buzzSound = new Audio('buzz.wav');

    // Remplit le menu déroulant
    themes.forEach((theme, i) => {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = theme.name;
      playlistSelect.appendChild(opt);
    });
    playlistSelect.onchange = function() {
      if (playlistSelect.value !== '') {
        loadPlaylist(themes[playlistSelect.value].url);
        playlistInfo.textContent = `Playlist : ${themes[playlistSelect.value].name}`;
      } else {
        playlistInfo.textContent = '';
      }
    };

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function loadPlaylist(url) {
      playlist = [];
      currentIndex = 0;
      revealed = false;
      waitingForFirstPlay = true;
      trackDiv.innerHTML = '<div class="loader"></div><div style="text-align:center;margin-top:0.7em;">Chargement de la playlist...</div>';
      nextBtn.classList.add('hidden');
      revealBtn.classList.add('hidden');
      playPauseBtn.disabled = false;
      // JSONP Deezer
      const cb = 'cb' + Math.floor(Math.random()*100000);
      window[cb] = function(data) {
        let tracks = data.tracks ? data.tracks.data : data.data;
        playlist = tracks.filter(t => t.preview);
        shuffle(playlist);
        // trackDiv.innerHTML = '<b>Appuyez sur Play pour commencer</b>';
        trackDiv.innerHTML = '<div style="text-align:center;font-size:1.2em;color:#7c4dff;">Appuyez sur <b>Play</b> pour commencer</div>';
      };
      const script = document.createElement('script');
      script.src = url + (url.includes('?') ? '&' : '?') + 'output=jsonp&callback=' + cb;
      document.body.appendChild(script);
    }
    function updatePlayPauseBtn() {
      const audio = document.getElementById('audio');
      const icon = playPauseBtn.querySelector('svg');
      const label = playPauseBtn.querySelector('span');
      if (audio && !audio.paused) {
        // Pause icon
        icon.innerHTML = '<rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/>';
        label.textContent = 'Pause';
      } else {
        // Play icon
        icon.innerHTML = '<path d="M8 5v14l11-7z"/>';
        label.textContent = 'Play';
      }
    }
    function setAudioListeners() {
      const audio = document.getElementById('audio');
      if (!audio) return;
      audio.onplay = function() { socket.emit('start'); updatePlayPauseBtn(); };
      audio.onpause = function() { socket.emit('pause'); updatePlayPauseBtn(); };
    }
    function showTrack() {
      if (!playlist.length) { trackDiv.innerHTML = 'Aucune piste.'; return; }
      const track = playlist[currentIndex];
      revealed = false;
      trackDiv.className = '';
      trackDiv.innerHTML = `
        <div style="margin-bottom:0.5em;font-size:1.1em;color:#7c4dff;">Piste ${currentIndex+1} / ${playlist.length}</div>
        <div><img id="cover" src="${track.album.cover_medium}" alt="cover" /></div>
        <div class="track-title" title="${track.title}">Titre : <b>???</b></div>
        <div class="track-artist" title="${track.artist.name}">Artiste : <b>???</b></div>
        <audio id="audio" src="${track.preview}" controls></audio>
      `;
      nextBtn.classList.remove('hidden');
      revealBtn.classList.remove('hidden');
      revealBtn.disabled = false;
      resetTimerLocal();
      setTimeout(() => {
        setAudioListeners();
        updatePlayPauseBtn();
        const audio = document.getElementById('audio');
        if (audio) {
          audio.play();
          socket.emit('start');
       }
      }, 100);
    }
    function resetTimerLocal() {
      socket.emit('reset');
    }
    nextBtn.onclick = function() {
      if (currentIndex < playlist.length - 1) {
        currentIndex++;
        showTrack();
      }
    };
    revealBtn.onclick = function() {
      if (!playlist.length) return;
      const track = playlist[currentIndex];
      revealed = true;
      trackDiv.className = 'revealed';
      const titleDiv = trackDiv.querySelector('.track-title b');
      const artistDiv = trackDiv.querySelector('.track-artist b');
      const titleCont = trackDiv.querySelector('.track-title');
      const artistCont = trackDiv.querySelector('.track-artist');
      if (titleDiv) titleDiv.innerHTML = `<span style='font-size:2.5em;'>${track.title}</span>`;
      if (artistDiv) artistDiv.innerHTML = `<span style='font-size:2em;'>${track.artist.name}</span>`;
      if (titleCont) titleCont.title = track.title;
      if (artistCont) artistCont.title = track.artist.name;
      const cover = trackDiv.querySelector('#cover');
      if (cover) cover.style.filter = '';
      revealBtn.disabled = true;
      setTimeout(() => { setAudioListeners(); updatePlayPauseBtn(); }, 100);
      socket.emit('reveal');
    };
    playPauseBtn.onclick = function() {
      if (waitingForFirstPlay) {
        showTrack();
        const audio = document.getElementById('audio');
        if (audio) {
          audio.play();
          socket.emit('start');
        }
        waitingForFirstPlay = false;
        return;
      }
      const audio = document.getElementById('audio');
      if (audio) {
        if (audio.paused) {
          audio.play();
          socket.emit('start');
        } else {
          audio.pause();
          socket.emit('pause');
        }
      }
    };
    let lastTimerValue = 30;
    let dvdX = 10, dvdY = 10, dvdVX = 1.2, dvdVY = 1.1;
    let dvdW = 200, dvdH = 100;
    function moveDVDTimer() {
      const cont = document.querySelector('.main-container');
      if (!cont) return;
      const contRect = cont.getBoundingClientRect();
      dvdW = timerDVD.offsetWidth;
      dvdH = timerDVD.offsetHeight;
      dvdX += dvdVX;
      dvdY += dvdVY;
      if (dvdX < 0) { dvdX = 0; dvdVX *= -1; timerDVD.style.color = randomColor(); }
      if (dvdY < 0) { dvdY = 0; dvdVY *= -1; timerDVD.style.color = randomColor(); }
      if (dvdX + dvdW > contRect.width) { dvdX = contRect.width - dvdW; dvdVX *= -1; timerDVD.style.color = randomColor(); }
      if (dvdY + dvdH > contRect.height) { dvdY = contRect.height - dvdH; dvdVY *= -1; timerDVD.style.color = randomColor(); }
      timerDVD.style.transform = `translate(${dvdX}px,${dvdY}px)`;
      requestAnimationFrame(moveDVDTimer);
    }
    function randomColor() {
      const colors = ['#5a6cff','#ff9800','#f44336','#00bfae','#7c4dff','#00bcd4','#ffeb3b'];
      return colors[Math.floor(Math.random()*colors.length)];
    }
    moveDVDTimer();
    socket.on('timer', ({ timer, isPaused }) => {
      timerDVD.innerHTML = isPaused
        ? `<span>${timer}</span><span style="font-size:0.7em;opacity:0.7;margin-left:0.2em;">⏸️</span>`
        : `<span>${timer}</span>`;
      if (timer !== lastTimerValue) {
        timerDVD.style.animation = 'none';
        void timerDVD.offsetWidth;
        timerDVD.style.animation = '';
      }
      lastTimerValue = timer;
      if (timer > 15) {
        timerDVD.style.textShadow = '0 0 10px #5a6cff55';
      } else if (timer > 5) {
        timerDVD.style.textShadow = '0 0 10px #ff980055';
      } else {
        timerDVD.style.textShadow = '0 0 16px #f4433655, 0 0 4px #fff';
      }
    });
    socket.on('buzzer', (name) => {
      if (name === 'revealed') {
        buzzerDiv.innerHTML = '<span style="color:#7c4dff;">🎤 Révélé ! Tout le monde connaît la vérité... ou presque ! 🤫</span>';
        buzzerDiv.style.background = '#ede7f6';
        buzzerDiv.style.color = '#7c4dff';
        buzzerDiv.classList.remove('buzzer-pop');
        void buzzerDiv.offsetWidth;
        buzzerDiv.classList.add('buzzer-pop');
      } else if (name) {
        buzzerDiv.innerHTML = '<span style="color:#00bfae;">🚨 BUZZ : <b>' + name + '</b> a dégainé plus vite que son ombre ! ⚡️</span>';
        buzzerDiv.style.background = '#b2fef7';
        buzzerDiv.style.color = '#00bfae';
        buzzerDiv.classList.remove('buzzer-pop');
        void buzzerDiv.offsetWidth;
        buzzerDiv.classList.add('buzzer-pop');
        buzzSound.currentTime = 0;
        buzzSound.play();
        const audio = document.getElementById('audio');
        if (audio && !audio.paused) {
          audio.pause();
        }
      } else {
        buzzerDiv.innerHTML = "<span style='color:#5a6cff;'>Personne n'a buzzé... pour l'instant ! 😴</span>";
        buzzerDiv.style.background = '';
        buzzerDiv.style.color = '#5a6cff';
        buzzerDiv.classList.remove('buzzer-pop');
      }
    });
  </script>
</body>
</html> 